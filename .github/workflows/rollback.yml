name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      rollback_type:
        description: 'Rollback type'
        required: true
        type: choice
        options:
          - slot-swap
          - previous-image
          - specific-version

env:
  NODE_VERSION: '18'

jobs:
  rollback-slot-swap:
    name: Rollback via Slot Swap
    runs-on: ubuntu-latest
    if: github.event.inputs.rollback_type == 'slot-swap'
    environment:
      name: ${{ github.event.inputs.environment }}-rollback

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Determine app name
        id: app
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "name=gas-app-production" >> $GITHUB_OUTPUT
          else
            echo "name=gas-app-staging" >> $GITHUB_OUTPUT
          fi

      - name: Swap slots back
        run: |
          az webapp deployment slot swap \
            --name ${{ steps.app.outputs.name }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --slot blue \
            --target-slot production

      - name: Verify rollback
        run: |
          APP_URL="https://${{ steps.app.outputs.name }}.azurewebsites.net"
          for i in {1..10}; do
            if curl -f -s "$APP_URL/health" > /dev/null; then
              echo "✅ Rollback successful - health check passed"
              exit 0
            fi
            sleep 10
          done
          echo "❌ Rollback verification failed"
          exit 1

  rollback-previous-image:
    name: Rollback to Previous Image
    runs-on: ubuntu-latest
    if: github.event.inputs.rollback_type == 'previous-image'
    environment:
      name: ${{ github.event.inputs.environment }}-rollback

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get previous commit
        id: prev
        run: |
          PREV_SHA=$(git rev-parse HEAD~1)
          echo "sha=$PREV_SHA" >> $GITHUB_OUTPUT

      - name: Determine app name
        id: app
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "name=gas-app-production" >> $GITHUB_OUTPUT
            echo "tag=prod-${{ steps.prev.outputs.sha }}" >> $GITHUB_OUTPUT
          else
            echo "name=gas-app-staging" >> $GITHUB_OUTPUT
            echo "tag=staging-${{ steps.prev.outputs.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy previous image
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ steps.app.outputs.name }}
          images: ${{ secrets.ACR_LOGIN_SERVER }}/gas-app:${{ steps.app.outputs.tag }}

      - name: Wait for deployment
        run: sleep 30

      - name: Verify rollback
        run: |
          APP_URL="https://${{ steps.app.outputs.name }}.azurewebsites.net"
          for i in {1..10}; do
            if curl -f -s "$APP_URL/health" > /dev/null; then
              echo "✅ Rollback to previous image successful"
              exit 0
            fi
            sleep 10
          done
          echo "❌ Rollback verification failed"
          exit 1

  notify-rollback:
    name: Notify Rollback Status
    runs-on: ubuntu-latest
    needs: [rollback-slot-swap, rollback-previous-image]
    if: always()

    steps:
      - name: Rollback Success
        if: |
          (needs.rollback-slot-swap.result == 'success' && needs.rollback-slot-swap.result != 'skipped') ||
          (needs.rollback-previous-image.result == 'success' && needs.rollback-previous-image.result != 'skipped')
        run: |
          echo "✅ Rollback completed successfully for ${{ github.event.inputs.environment }}"

      - name: Rollback Failed
        if: |
          needs.rollback-slot-swap.result == 'failure' ||
          needs.rollback-previous-image.result == 'failure'
        run: |
          echo "❌ Rollback failed for ${{ github.event.inputs.environment }}"
          exit 1
